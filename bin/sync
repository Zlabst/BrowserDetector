#!/bin/sh

user=kredit_geld_de
path=/var/www/vhosts/kreditcalc.geld.de
destination=/var/www/vhosts/kreditcalc.geld.de
slaves="finanzslave01 finanzslave02 slave57 slave47"
directories="library application public"
log=$path/sync_`date +%Y-%m-%d`.log
cachedirs="aidu browser calculation date db doctrine filecache locale models navigation sitecache tags tests"

echo "-----------------------------------------------------------------------------------------------------------------" | tee -a $log
#delete cache files
#delete Folders
echo "--- delete cache" | tee -a $log

for cachedir in $cachedirs
do
    echo "--- COMMAND: rm -rf $path/data/cache/$cachedir/*" | tee -a $log
    rm -rf $path/data/cache/$cachedir/* | tee -a $log
done

echo "--- COMMAND: rm -rf $path/data/log/{error,exception,tests}/*" | tee -a $log
rm -rf $path/data/log/{error,exception,tests}/* | tee -a $log

echo "--- COMMAND: rm -rf $path/data/{browser,plugincache}/*" | tee -a $log
rm -rf $path/data/{browser,plugincache}/* | tee -a $log

#copy runmode.php
#cp -f $path/httpdocs/runmode.online.php $path/httpdocs/runmode.php

for slave in $slaves
do
    for directory in $directories
    do
        echo "--- SYNC START [$slave] [$directory] [`date "+%Y-%m-%d %H:%M:%S"`] ---" | tee -a $log
        echo "--- COMMAND: rsync --delete -vrptl --numeric-ids -e ssh $path/$directory/ $user@$slave:$destination/$directory/ ---" | tee -a $log
        rsync --delete -vrptl --numeric-ids -e ssh $path/$directory/ $user@$slave:$destination/$directory/ | tee -a $log
        echo "--- SYNC END [$slave] [$directory] [`date "+%Y-%m-%d %H:%M:%S"`] ---" | tee -a $log
    done

    echo "--- FLUSHING CACHES START" | tee -a $log
    for cachedir in $cachedirs
    do
        echo "--- COMMAND: ssh $user@$slave find $destination/data/cache/$cachedir -type f | xargs rm ---" | tee -a $log
        ssh $user@$slave "find $destination/data/cache/$cachedir -type f | xargs rm" | tee -a $log
    done

    echo "--- COMMAND: ssh $user@$slave find $destination/data/log/error -type f | xargs rm ---" | tee -a $log
    ssh $user@$slave "find $destination/data/log/error -type f | xargs rm" | tee -a $log
    
    echo "--- COMMAND: ssh $user@$slave find $destination/data/log/exception -type f | xargs rm ---" | tee -a $log
    ssh $user@$slave "find $destination/data/log/exception -type f | xargs rm" | tee -a $log
    
    echo "--- COMMAND: ssh $user@$slave find $destination/data/log/tests -type f | xargs rm ---" | tee -a $log
    ssh $user@$slave "find $destination/data/log/tests -type f | xargs rm" | tee -a $log

    echo "--- COMMAND: ssh $user@$slave find $destination/data/plugincache -type f | xargs rm ---" | tee -a $log
    ssh $user@$slave "find $destination/data/plugincache -type f | xargs rm" | tee -a $log
    
    echo "--- COMMAND: ssh $user@$slave find $destination/data/browser -type f | xargs rm ---" | tee -a $log
    ssh $user@$slave "find $destination/data/browser -type f | xargs rm" | tee -a $log
    
    echo "--- COMMAND: wget -q --delete-after http://[$slave]/xcache-admin/clear" | tee -a $log
    #wget -q --delete-after http://[$slave]/xcache-admin/clear
    wget -q --save-headers -O - http://$slave/xcache-admin/clear | grep "200 OK" | tee -a $log
    echo "--- FLUSHING CACHES END" | tee -a $log

    for cachedir in $cachedirs
    do
        echo "--- COMMAND: ssh $user@$slave find $destination/data/log/cache/$cachedir -type f | xargs rm ---" | tee -a $log
        ssh $user@$slave "find $destination/data/cache/$cachedir -type f | xargs rm" | tee -a $log
    done
    
	echo "--- COMMAND: wget -q --delete-after http://[$slave]/xcache-admin/clear" | tee -a $log
    wget -q --delete-after http://[$slave]/xcache-admin/clear
done

#copy runmode.php
#cp -f $path/httpdocs/runmode.stage.php $path/httpdocs/runmode.php

#copy revision
echo "--- copy Revision" | tee -a $log
echo "--- COMMAND: cp -f $path/revision $path/revision-online" | tee -a $log
cp -f $path/revision $path/revision-online | tee -a $log

date
